<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>å®¶è¨ˆãƒ¡ãƒ¢</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400;500;700;900&family=Josefin+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{--navy:#1a2744;--navy2:#243055;--navy3:#2e3d6b;--orange:#f4651a;--white:#ffffff;--off:#f5f4f0;--border:#dde0ea;--muted:#8890aa;--light:#eef0f7;--red:#e03e3e;--green:#2a9d5c;}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{background:var(--off);color:var(--navy);font-family:'Zen Kaku Gothic New',sans-serif;min-height:100dvh;padding-bottom:80px}
.header{background:var(--navy);padding:20px 20px 0;position:sticky;top:0;z-index:100}
.header-inner{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px}
.app-name{font-family:'Josefin Sans',sans-serif;font-size:11px;font-weight:600;letter-spacing:3px;text-transform:uppercase;color:rgba(255,255,255,.4);margin-bottom:4px}
.month-label{font-family:'Josefin Sans',sans-serif;font-size:22px;font-weight:700;color:#fff;letter-spacing:-.5px}
.total-label{font-size:10px;color:rgba(255,255,255,.4);letter-spacing:1.5px;text-transform:uppercase;font-family:'Josefin Sans',sans-serif;text-align:right;margin-bottom:2px}
.total-amount{font-family:'Josefin Sans',sans-serif;font-size:28px;font-weight:700;color:#fff;letter-spacing:-1px}
.total-yen{font-size:16px;font-weight:300;opacity:.7;margin-right:2px}
.tabs{display:flex;margin:0 -20px}
.tab-btn{flex:1;padding:11px 0 13px;background:none;border:none;color:rgba(255,255,255,.35);font-size:12px;font-family:'Josefin Sans',sans-serif;font-weight:600;letter-spacing:1px;text-transform:uppercase;cursor:pointer;position:relative;transition:color .2s}
.tab-btn::after{content:'';position:absolute;bottom:0;left:50%;right:50%;height:3px;background:var(--orange);border-radius:3px 3px 0 0;transition:all .25s ease}
.tab-btn.active{color:#fff}
.tab-btn.active::after{left:10px;right:10px}
.content{padding:20px}
.tab-panel{display:none}
.tab-panel.active{display:block;animation:fu .2s ease}
@keyframes fu{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.card{background:var(--white);border-radius:16px;padding:22px 20px;margin-bottom:14px;box-shadow:0 1px 3px rgba(26,39,68,.07),0 4px 14px rgba(26,39,68,.05)}
.form-section{margin-bottom:20px}
.form-label{font-size:10px;font-weight:700;font-family:'Josefin Sans',sans-serif;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;display:block}
.calc-display{background:var(--light);border:2px solid transparent;border-radius:12px;padding:14px 16px;margin-bottom:10px;cursor:pointer;transition:border-color .2s;min-height:72px}
.calc-display.active-input{border-color:var(--orange);background:#fff9f6}
.calc-expr{font-size:13px;color:var(--muted);font-family:'Josefin Sans',sans-serif;min-height:18px;letter-spacing:.5px}
.calc-result{display:flex;align-items:baseline;gap:4px}
.calc-yen{font-family:'Josefin Sans',sans-serif;font-size:18px;font-weight:300;color:var(--muted)}
.calc-value{font-family:'Josefin Sans',sans-serif;font-size:36px;font-weight:700;color:var(--navy);letter-spacing:-1px;min-height:44px;line-height:1.1}
.calc-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.calc-btn{height:52px;border-radius:10px;border:none;font-size:18px;font-family:'Josefin Sans',sans-serif;font-weight:600;cursor:pointer;transition:all .1s;display:flex;align-items:center;justify-content:center}
.calc-btn:active{transform:scale(.94)}
.cb-num{background:var(--light);color:var(--navy)}
.cb-op{background:#e8ebf5;color:var(--navy2);font-size:20px}
.cb-eq{background:var(--orange);color:#fff;font-size:20px}
.cb-del{background:#fde8e8;color:var(--red)}
.cb-clear{background:#e8ebf5;color:var(--navy2);font-size:14px;letter-spacing:.5px}
.cb-zero{grid-column:span 2}
.form-input{width:100%;background:var(--light);border:2px solid transparent;border-radius:12px;padding:13px 16px;color:var(--navy);font-size:15px;font-family:'Zen Kaku Gothic New',sans-serif;outline:none;transition:border-color .2s,background .2s;-webkit-appearance:none}
.form-input:focus{border-color:var(--orange);background:#fff9f6}
.form-input::placeholder{color:var(--border)}
.chip-wrap{display:flex;flex-wrap:wrap;gap:7px}
.chip{padding:7px 13px;border-radius:8px;border:1.5px solid var(--border);background:var(--white);color:var(--muted);font-size:13px;font-family:'Zen Kaku Gothic New',sans-serif;font-weight:500;cursor:pointer;transition:all .15s;user-select:none}
.chip:active{transform:scale(.96)}
.chip.sel{background:var(--navy);border-color:var(--navy);color:#fff}
.type-toggle{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.type-btn{padding:12px;border-radius:12px;border:2px solid var(--border);background:var(--white);color:var(--muted);font-size:14px;font-family:'Zen Kaku Gothic New',sans-serif;font-weight:700;cursor:pointer;transition:all .15s;text-align:center}
.type-btn.sel-fixed{border-color:var(--navy);background:var(--navy);color:#fff}
.type-btn.sel-var{border-color:var(--orange);background:var(--orange);color:#fff}
.expense-row{display:flex;align-items:center;gap:12px;background:var(--light);border-radius:12px;padding:13px 16px;cursor:pointer;transition:all .15s;border:2px solid transparent}
.expense-row.checked{background:#fff8f0;border-color:var(--orange)}
.expense-check{width:22px;height:22px;border-radius:6px;border:2px solid var(--border);background:var(--white);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .15s;font-size:13px;color:#fff}
.expense-row.checked .expense-check{background:var(--orange);border-color:var(--orange)}
.expense-label{font-size:14px;font-weight:700;color:var(--muted)}
.expense-row.checked .expense-label{color:var(--orange)}
.expense-subjects{display:none;margin-top:10px}
.expense-subjects.open{display:block}
.divider{height:1px;background:var(--border);margin:20px 0}
.submit-btn{width:100%;padding:16px;border-radius:12px;border:none;background:var(--orange);color:#fff;font-size:15px;font-family:'Josefin Sans',sans-serif;font-weight:700;letter-spacing:2.5px;text-transform:uppercase;cursor:pointer;transition:background .2s,transform .1s}
.submit-btn:active{transform:scale(.98);background:#d45510}
.submit-btn:disabled{opacity:.45;cursor:not-allowed}
.section-label{font-family:'Josefin Sans',sans-serif;font-size:10px;font-weight:700;letter-spacing:2.5px;text-transform:uppercase;color:var(--muted);margin-bottom:12px}
.hist-filter{display:flex;gap:8px;margin-bottom:14px;overflow-x:auto;padding-bottom:2px}
.hist-filter::-webkit-scrollbar{display:none}
.fchip{padding:6px 13px;border-radius:20px;border:1.5px solid var(--border);background:var(--white);color:var(--muted);font-size:12px;font-family:'Josefin Sans',sans-serif;font-weight:600;cursor:pointer;white-space:nowrap;transition:all .15s}
.fchip.sel{background:var(--navy);border-color:var(--navy);color:#fff}
.record-item{display:flex;align-items:center;gap:14px;padding:13px 0;border-bottom:1px solid var(--border)}
.record-item:last-child{border-bottom:none;padding-bottom:0}
.record-item:first-child{padding-top:0}
.record-dot{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.record-dot.fixed{background:var(--light)}
.record-dot.variable{background:#fff3ee}
.record-body{flex:1;min-width:0}
.record-cat{font-size:14px;font-weight:700;color:var(--navy);margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.record-sub{font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.record-right{text-align:right;flex-shrink:0}
.record-amount{font-family:'Josefin Sans',sans-serif;font-size:17px;font-weight:700;color:var(--navy);letter-spacing:-.5px}
.rec-badges{display:flex;gap:4px;justify-content:flex-end;margin-top:3px;flex-wrap:wrap}
.rec-badge{display:inline-block;font-size:10px;font-family:'Josefin Sans',sans-serif;font-weight:700;letter-spacing:.5px;padding:2px 7px;border-radius:4px}
.rb-fixed{background:var(--light);color:var(--navy3)}
.rb-variable{background:#fff3ee;color:var(--orange)}
.rb-credit{background:#eff6ff;color:#2563eb}
.rb-cash{background:#f0fdf4;color:var(--green)}
.rb-expense{background:#fff8f0;color:var(--orange);border:1px solid #fcd9b8}
.loading-state{text-align:center;padding:40px 0;color:var(--muted)}
.loading-spin{font-size:28px;animation:spin 1s linear infinite;display:inline-block;margin-bottom:10px}
@keyframes spin{to{transform:rotate(360deg)}}
.empty-state{text-align:center;padding:48px 0;color:var(--muted)}
.empty-icon{font-size:38px;margin-bottom:10px;opacity:.45}
.empty-text{font-size:13px;letter-spacing:.5px}
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
.stat-card{background:var(--white);border-radius:14px;padding:16px;box-shadow:0 1px 3px rgba(26,39,68,.06)}
.stat-card.accent-navy{background:var(--navy)}
.stat-label{font-family:'Josefin Sans',sans-serif;font-size:10px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:6px}
.stat-card.accent-navy .stat-label{color:rgba(255,255,255,.45)}
.stat-value{font-family:'Josefin Sans',sans-serif;font-size:22px;font-weight:700;color:var(--navy);letter-spacing:-.5px}
.stat-card.accent-navy .stat-value{color:#fff}
.stat-card.accent-orange .stat-value{color:var(--orange)}
.payer-row{padding:10px 0;border-bottom:1px solid var(--border)}
.payer-row:last-child{border-bottom:none}
.payer-top{display:flex;justify-content:space-between;margin-bottom:5px}
.payer-name{font-size:14px;font-weight:700;color:var(--navy)}
.payer-amount{font-family:'Josefin Sans',sans-serif;font-size:15px;font-weight:700;color:var(--navy)}
.bar-track{height:4px;background:var(--light);border-radius:2px;overflow:hidden}
.bar-fill{height:100%;border-radius:2px;transition:width .8s cubic-bezier(.16,1,.3,1)}
.bar-fill.orange{background:var(--orange)}
.bar-fill.navy{background:var(--navy)}
.cat-row{margin-bottom:13px}
.cat-row:last-child{margin-bottom:0}
.cat-top{display:flex;justify-content:space-between;font-size:13px;font-weight:500;margin-bottom:5px}
.cat-top-name{color:var(--navy)}
.cat-top-amt{font-family:'Josefin Sans',sans-serif;font-weight:700;color:var(--orange)}
.settings-section{margin-bottom:24px}
.settings-title{font-family:'Josefin Sans',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:12px}
.cat-list,.method-list,.place-list{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
.cat-list-item,.method-item,.place-item{display:flex;align-items:center;gap:10px;background:var(--light);border-radius:10px;padding:10px 12px}
.cat-list-emoji{font-size:20px;width:28px;text-align:center;flex-shrink:0}
.cat-list-name,.method-name,.place-name{flex:1;font-size:14px;font-weight:500;color:var(--navy)}
.cat-del-btn,.method-del-btn,.place-del-btn{width:28px;height:28px;border-radius:7px;border:none;background:none;color:var(--muted);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .15s,color .15s;flex-shrink:0}
.cat-del-btn:hover,.method-del-btn:hover,.place-del-btn:hover{background:#fee2e2;color:var(--red)}
.add-cat-row{display:flex;gap:8px;align-items:center}
.emoji-pick-btn{width:46px;height:46px;border-radius:10px;border:2px solid var(--border);background:var(--white);font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:border-color .15s}
.emoji-pick-btn:focus{border-color:var(--orange);outline:none}
.add-name-input,.add-simple-input{flex:1;background:var(--light);border:2px solid transparent;border-radius:10px;padding:11px 14px;font-size:15px;font-family:'Zen Kaku Gothic New',sans-serif;color:var(--navy);outline:none;transition:border-color .2s}
.add-name-input:focus,.add-simple-input:focus{border-color:var(--orange);background:#fff9f6}
.add-name-input::placeholder,.add-simple-input::placeholder{color:var(--border)}
.add-btn{padding:11px 16px;border-radius:10px;border:none;background:var(--navy);color:#fff;font-size:14px;font-family:'Josefin Sans',sans-serif;font-weight:700;letter-spacing:1px;cursor:pointer;flex-shrink:0;transition:background .15s}
.add-btn:active{background:var(--navy2)}
.emoji-picker-wrap{position:relative}
.emoji-picker{position:absolute;top:calc(100% + 6px);left:0;z-index:300;background:var(--white);border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:0 8px 32px rgba(26,39,68,.15);display:none;width:260px}
.emoji-picker.open{display:block;animation:fu .15s ease}
.emoji-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
.e-btn{width:32px;height:32px;border:none;background:none;font-size:18px;cursor:pointer;border-radius:6px;transition:background .1s;display:flex;align-items:center;justify-content:center}
.e-btn:hover{background:var(--light)}
.add-simple-row{display:flex;gap:8px}
.gas-input-wrap{display:flex;flex-direction:column;gap:8px}
.gas-status{font-size:12px;padding:8px 12px;border-radius:8px;font-family:'Josefin Sans',sans-serif;font-weight:600;letter-spacing:.5px}
.gas-status.ok{background:#f0fdf4;color:var(--green)}
.gas-status.ng{background:#fff0f0;color:var(--red)}
.toast{position:fixed;bottom:96px;left:50%;transform:translateX(-50%) translateY(12px);background:var(--navy);color:#fff;padding:10px 24px;border-radius:30px;font-size:13px;font-family:'Josefin Sans',sans-serif;font-weight:600;letter-spacing:.5px;opacity:0;transition:all .3s ease;z-index:999;pointer-events:none;white-space:nowrap}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.ok{border-bottom:3px solid var(--orange)}
.toast.err{border-bottom:3px solid var(--red);background:#2d1e1e}
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--white);border-top:1px solid var(--border);display:flex;padding:6px 0 calc(6px + env(safe-area-inset-bottom));z-index:200}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;padding:7px 0;background:none;border:none;cursor:pointer;color:var(--border);font-size:9px;font-family:'Josefin Sans',sans-serif;font-weight:600;letter-spacing:1px;text-transform:uppercase;transition:color .2s}
.nav-btn.active{color:var(--navy)}
.nav-icon{font-size:20px;line-height:1}
</style>
</head>
<body>
<div class="header">
  <div class="header-inner">
    <div>
      <div class="app-name">Kakeibo</div>
      <div class="month-label" id="monthLabel">â€”</div>
    </div>
    <div>
      <div class="total-label">ä»Šæœˆã®æ”¯å‡º</div>
      <div class="total-amount"><span class="total-yen">Â¥</span><span id="monthTotal">0</span></div>
    </div>
  </div>
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('input',this)">å…¥åŠ›</button>
    <button class="tab-btn" onclick="switchTab('history',this)">å±¥æ­´</button>
    <button class="tab-btn" onclick="switchTab('summary',this)">é›†è¨ˆ</button>
    <button class="tab-btn" onclick="switchTab('settings',this)">è¨­å®š</button>
  </div>
</div>
<div class="content">
  <!-- å…¥åŠ› -->
  <div class="tab-panel active" id="tab-input">
    <div class="card">
      <div class="form-section">
        <label class="form-label">é‡‘é¡</label>
        <div class="calc-display" id="calcDisplay">
          <div class="calc-expr" id="calcExpr">&nbsp;</div>
          <div class="calc-result"><span class="calc-yen">Â¥</span><span class="calc-value" id="calcValue">0</span></div>
        </div>
        <div class="calc-grid">
          <button class="calc-btn cb-clear" onclick="calcClear()">AC</button>
          <button class="calc-btn cb-op" onclick="calcOp('%')">%</button>
          <button class="calc-btn cb-del" onclick="calcDel()">âŒ«</button>
          <button class="calc-btn cb-op" onclick="calcOp('Ã·')">Ã·</button>
          <button class="calc-btn cb-num" onclick="calcNum('7')">7</button>
          <button class="calc-btn cb-num" onclick="calcNum('8')">8</button>
          <button class="calc-btn cb-num" onclick="calcNum('9')">9</button>
          <button class="calc-btn cb-op" onclick="calcOp('Ã—')">Ã—</button>
          <button class="calc-btn cb-num" onclick="calcNum('4')">4</button>
          <button class="calc-btn cb-num" onclick="calcNum('5')">5</button>
          <button class="calc-btn cb-num" onclick="calcNum('6')">6</button>
          <button class="calc-btn cb-op" onclick="calcOp('âˆ’')">âˆ’</button>
          <button class="calc-btn cb-num" onclick="calcNum('1')">1</button>
          <button class="calc-btn cb-num" onclick="calcNum('2')">2</button>
          <button class="calc-btn cb-num" onclick="calcNum('3')">3</button>
          <button class="calc-btn cb-op" onclick="calcOp('+')">+</button>
          <button class="calc-btn cb-num cb-zero" onclick="calcNum('0')">0</button>
          <button class="calc-btn cb-num" onclick="calcNum('.')">.</button>
          <button class="calc-btn cb-eq" onclick="calcEqual()">=</button>
        </div>
      </div>
      <div class="form-section">
        <label class="form-label">æ—¥ä»˜</label>
        <input type="date" class="form-input" id="inputDate">
      </div>
      <div class="divider"></div>
      <div class="form-section">
        <label class="form-label">ã‚«ãƒ†ã‚´ãƒª</label>
        <div class="chip-wrap" id="catChips"></div>
      </div>
      <div class="form-section">
        <label class="form-label">å›ºå®šè²» / å¤‰å‹•è²»</label>
        <div class="type-toggle">
          <button class="type-btn" id="btnFixed" onclick="selType('fixed')">ğŸ”’ å›ºå®šè²»</button>
          <button class="type-btn" id="btnVar" onclick="selType('variable')">ğŸŒŠ å¤‰å‹•è²»</button>
        </div>
      </div>
      <div class="form-section">
        <label class="form-label">æ”¯æ‰•ã„æ–¹æ³•</label>
        <div class="chip-wrap" id="methodChips"></div>
      </div>
      <div class="form-section">
        <label class="form-label">æ”¯æ‰•ã„è€…</label>
        <div class="chip-wrap">
          <div class="chip" data-g="payer" data-v="å´‡ç§€" onclick="selChip(this,'payer')">å´‡ç§€</div>
          <div class="chip" data-g="payer" data-v="æœªç´—" onclick="selChip(this,'payer')">æœªç´—</div>
          <div class="chip" data-g="payer" data-v="å…±åŒ" onclick="selChip(this,'payer')">å…±åŒ</div>
        </div>
      </div>
      <div class="form-section">
        <label class="form-label">è³¼å…¥å ´æ‰€ï¼ˆä»»æ„ï¼‰</label>
        <div class="chip-wrap" id="placeChips" style="margin-bottom:8px"></div>
        <input type="text" class="form-input" id="inputPlace" placeholder="ã¾ãŸã¯ç›´æ¥å…¥åŠ›â€¦">
      </div>
      <div class="form-section">
        <label class="form-label">çµŒè²»</label>
        <div class="expense-row" id="expenseRow" onclick="toggleExpense()">
          <div class="expense-check" id="expenseCheck"></div>
          <span class="expense-label">çµŒè²»ã¨ã—ã¦è¨˜éŒ²ã™ã‚‹</span>
        </div>
        <div class="expense-subjects" id="expenseSubjects">
          <div style="margin-top:10px">
            <label class="form-label">å‹˜å®šç§‘ç›®</label>
            <div class="chip-wrap" id="subjectChips">
              <div class="chip" data-g="subject" data-v="äº¤é€šè²»" onclick="selChip(this,'subject')">ğŸšƒ äº¤é€šè²»</div>
              <div class="chip" data-g="subject" data-v="é€šä¿¡è²»" onclick="selChip(this,'subject')">ğŸ“± é€šä¿¡è²»</div>
              <div class="chip" data-g="subject" data-v="æ¥å¾…äº¤éš›è²»" onclick="selChip(this,'subject')">ğŸ½ æ¥å¾…äº¤éš›è²»</div>
              <div class="chip" data-g="subject" data-v="æ¶ˆè€—å“è²»" onclick="selChip(this,'subject')">ğŸ“¦ æ¶ˆè€—å“è²»</div>
              <div class="chip" data-g="subject" data-v="åºƒå‘Šå®£ä¼è²»" onclick="selChip(this,'subject')">ğŸ“¢ åºƒå‘Šå®£ä¼è²»</div>
              <div class="chip" data-g="subject" data-v="ç ”ä¿®è²»" onclick="selChip(this,'subject')">ğŸ“š ç ”ä¿®è²»</div>
              <div class="chip" data-g="subject" data-v="é›‘è²»" onclick="selChip(this,'subject')">ğŸ“‹ é›‘è²»</div>
            </div>
          </div>
        </div>
      </div>
      <div class="form-section" style="margin-bottom:0">
        <label class="form-label">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
        <input type="text" class="form-input" id="inputMemo" placeholder="è£œè¶³ãªã©">
      </div>
      <div class="divider"></div>
      <button class="submit-btn" id="submitBtn" onclick="doSubmit()">è¨˜éŒ²ã™ã‚‹</button>
    </div>
  </div>
  <!-- å±¥æ­´ -->
  <div class="tab-panel" id="tab-history">
    <div class="hist-filter">
      <div class="fchip sel" data-f="all" onclick="setFilter('all',this)">ã™ã¹ã¦</div>
      <div class="fchip" data-f="å´‡ç§€" onclick="setFilter('å´‡ç§€',this)">å´‡ç§€</div>
      <div class="fchip" data-f="æœªç´—" onclick="setFilter('æœªç´—',this)">æœªç´—</div>
      <div class="fchip" data-f="expense" onclick="setFilter('expense',this)">ğŸ’¼ çµŒè²»ã®ã¿</div>
    </div>
    <div style="display:flex;justify-content:flex-end;margin-bottom:10px">
      <button onclick="loadRemote()" style="background:none;border:none;color:var(--muted);font-size:12px;font-family:'Josefin Sans',sans-serif;font-weight:600;cursor:pointer;letter-spacing:1px;text-transform:uppercase">â†» æœ€æ–°ã‚’å–å¾—</button>
    </div>
    <div class="section-label">ä»Šæœˆã®è¨˜éŒ²</div>
    <div class="card" id="histCard">
      <div class="empty-state"><div class="empty-icon">ğŸ—’ï¸</div><div class="empty-text">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div></div>
    </div>
  </div>
  <!-- é›†è¨ˆ -->
  <div class="tab-panel" id="tab-summary">
    <div class="stat-grid">
      <div class="stat-card accent-navy"><div class="stat-label">ä»Šæœˆåˆè¨ˆ</div><div class="stat-value" id="sTotal">Â¥0</div></div>
      <div class="stat-card"><div class="stat-label">ä»¶æ•°</div><div class="stat-value" id="sCount">0</div></div>
      <div class="stat-card"><div class="stat-label">å›ºå®šè²»</div><div class="stat-value" id="sFixed">Â¥0</div></div>
      <div class="stat-card accent-orange"><div class="stat-label">å¤‰å‹•è²»</div><div class="stat-value" id="sVar">Â¥0</div></div>
      <div class="stat-card" style="grid-column:span 2"><div class="stat-label">ğŸ’¼ ã†ã¡çµŒè²»</div><div class="stat-value" id="sExpense">Â¥0</div></div>
    </div>
    <div class="section-label">æ”¯æ‰•ã„æ–¹æ³•åˆ¥</div>
    <div class="card" style="margin-bottom:14px"><div id="methodBreak"></div></div>
    <div class="section-label">æ”¯æ‰•ã„è€…åˆ¥</div>
    <div class="card" style="margin-bottom:14px"><div id="payerBreak"></div></div>
    <div class="section-label">ã‚«ãƒ†ã‚´ãƒªåˆ¥</div>
    <div class="card"><div id="catBars"></div></div>
  </div>
  <!-- è¨­å®š -->
  <div class="tab-panel" id="tab-settings">
    <div class="card settings-section">
      <div class="settings-title">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æº</div>
      <div class="gas-input-wrap">
        <input type="text" class="form-input" id="gasUrlInput" placeholder="GAS Web App URL ã‚’è²¼ã‚Šä»˜ã‘">
        <button class="add-btn" style="width:100%;text-align:center;padding:13px" onclick="saveGasUrl()">ä¿å­˜</button>
        <div class="gas-status" id="gasStatus" style="display:none"></div>
      </div>
    </div>
    <div class="card settings-section">
      <div class="settings-title">ã‚«ãƒ†ã‚´ãƒª</div>
      <div class="cat-list" id="catList"></div>
      <div class="add-cat-row">
        <div class="emoji-picker-wrap">
          <button class="emoji-pick-btn" id="emojiPickBtn" onclick="toggleEmojiPicker(event)">â•</button>
          <div class="emoji-picker" id="emojiPicker"><div class="emoji-grid" id="emojiGrid"></div></div>
        </div>
        <input type="text" class="add-name-input" id="newCatName" placeholder="ã‚«ãƒ†ã‚´ãƒªå">
        <button class="add-btn" onclick="addCategory()">è¿½åŠ </button>
      </div>
    </div>
    <div class="card settings-section">
      <div class="settings-title">è³¼å…¥å ´æ‰€</div>
      <div class="place-list" id="placeList"></div>
      <div class="add-simple-row">
        <input type="text" class="add-simple-input" id="newPlaceName" placeholder="ä¾‹ï¼šã‚¤ã‚ªãƒ³ã€ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢ãªã©">
        <button class="add-btn" onclick="addPlace()">è¿½åŠ </button>
      </div>
    </div>
    <div class="card settings-section" style="margin-bottom:0">
      <div class="settings-title">æ”¯æ‰•ã„æ–¹æ³•</div>
      <div class="method-list" id="methodList"></div>
      <div class="add-simple-row">
        <input type="text" class="add-simple-input" id="newMethodName" placeholder="ä¾‹ï¼šæ¥½å¤©ã‚«ãƒ¼ãƒ‰ã€PayPayãªã©">
        <button class="add-btn" onclick="addMethod()">è¿½åŠ </button>
      </div>
    </div>
  </div>
</div>
<div class="toast" id="toast"></div>
<script>
const DEFAULT_CATS=[{emoji:'ğŸ›’',name:'é£Ÿè²»'},{emoji:'ğŸ½',name:'å¤–é£Ÿ'},{emoji:'ğŸ ',name:'ä½å±…'},{emoji:'ğŸ’¡',name:'å…‰ç†±è²»'},{emoji:'ğŸ“±',name:'é€šä¿¡'},{emoji:'ğŸšƒ',name:'äº¤é€š'},{emoji:'ğŸ‘•',name:'è¡£é¡'},{emoji:'ğŸ’Š',name:'åŒ»ç™‚'},{emoji:'ğŸ‰',name:'å¨¯æ¥½'},{emoji:'ğŸ“š',name:'æ•™è‚²'},{emoji:'ğŸ¾',name:'ãƒšãƒƒãƒˆ'},{emoji:'ğŸ“¦',name:'ãã®ä»–'}];
const DEFAULT_PLACES=['ã‚¹ãƒ¼ãƒ‘ãƒ¼','ã‚³ãƒ³ãƒ“ãƒ‹','ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢','ãƒãƒƒãƒˆé€šè²©'];
const DEFAULT_METHODS=['ç¾é‡‘','ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ','PayPay','äº¤é€šç³»IC'];
const EMOJIS=['ğŸ›’','ğŸ½','ğŸ ','ğŸ’¡','ğŸ“±','ğŸšƒ','ğŸ‘•','ğŸ’Š','ğŸ‰','ğŸ“š','ğŸ¾','ğŸ“¦','ğŸµ','ğŸ‹','ğŸ¶','ğŸ±','ğŸŒ¸','â˜•','ğŸº','ğŸ®','âœˆ','ğŸ¥','ğŸ’¼','ğŸ','ğŸ§´','ğŸ¥—','ğŸš—','âš½','ğŸ“·','ğŸ¯','ğŸ’°','ğŸ¦','ğŸ”‘','ğŸŒ¿','ğŸœ','ğŸ›'];
const ls=(k,d)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d;}catch{return d;}};
const lss=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
let categories=ls('kk_cats',DEFAULT_CATS),places=ls('kk_places',DEFAULT_PLACES),methods=ls('kk_methods',DEFAULT_METHODS),records=ls('kk_recs',[]),gasUrl=ls('kk_gasurl','');
let sCat='',sType='',sPayer='',sMethod='',sPlace='',sSubject='',isExpense=false,pickedEmoji='ğŸ“¦',histFilter='all';
let cExpr='',cCur='0',cEvaled=false;

window.onload=()=>{
  const now=new Date();
  document.getElementById('inputDate').value=now.toISOString().split('T')[0];
  document.getElementById('monthLabel').textContent=`${now.getFullYear()}å¹´ ${now.getMonth()+1}æœˆ`;
  if(gasUrl){document.getElementById('gasUrlInput').value=gasUrl;showGasStatus(true);}
  buildEmojiGrid();renderForm();renderSettings();renderAll();
  document.addEventListener('click',e=>{if(!e.target.closest('.emoji-picker-wrap'))closeEmojiPicker();});
  if(gasUrl)loadRemote();
};

// é›»å“
function calcNum(n){
  if(cEvaled){cCur='0';cExpr='';cEvaled=false;}
  if(n==='.'&&cCur.includes('.'))return;
  cCur=cCur==='0'&&n!=='.'?n:cCur+n;
  updCalc();
}
function calcOp(op){cEvaled=false;cExpr=(cExpr||'0')+' '+cCur+' '+op;cCur='0';updCalc();}
function calcEqual(){
  const full=(cExpr+' '+cCur).trim();
  if(!full)return;
  try{
    const js=full.replace(/Ã—/g,'*').replace(/Ã·/g,'/').replace(/âˆ’/g,'-');
    const r=Math.round(Function('"use strict";return ('+js+')')() *100)/100;
    document.getElementById('calcExpr').textContent=full+' =';
    cCur=String(r);cExpr='';cEvaled=true;updCalc();
  }catch(e){toast('è¨ˆç®—ã‚¨ãƒ©ãƒ¼','err');}
}
function calcClear(){cCur='0';cExpr='';cEvaled=false;document.getElementById('calcExpr').textContent='\u00a0';updCalc();}
function calcDel(){if(cEvaled){calcClear();return;}cCur=cCur.length>1?cCur.slice(0,-1):'0';updCalc();}
function updCalc(){
  if(!cEvaled)document.getElementById('calcExpr').textContent=cExpr||'\u00a0';
  document.getElementById('calcValue').textContent=(parseFloat(cCur)||0).toLocaleString();
}

// çµŒè²»
function toggleExpense(){
  isExpense=!isExpense;
  document.getElementById('expenseRow').classList.toggle('checked',isExpense);
  document.getElementById('expenseCheck').textContent=isExpense?'âœ“':'';
  document.getElementById('expenseSubjects').classList.toggle('open',isExpense);
  if(!isExpense){sSubject='';document.querySelectorAll('[data-g="subject"]').forEach(c=>c.classList.remove('sel'));}
}

// ãƒ•ã‚©ãƒ¼ãƒ 
function renderForm(){
  const cw=document.getElementById('catChips');cw.innerHTML='';sCat='';
  categories.forEach(c=>{const l=c.emoji+' '+c.name;cw.appendChild(mkChip(l,'cat',l));});
  const mw=document.getElementById('methodChips');mw.innerHTML='';sMethod='';
  methods.forEach(m=>mw.appendChild(mkChip(m,'method',m)));
  const pw=document.getElementById('placeChips');pw.innerHTML='';sPlace='';
  places.forEach(p=>{const el=mkChip(p,'place',p);el.onclick=()=>{selChip(el,'place');document.getElementById('inputPlace').value=p;};pw.appendChild(el);});
}
function mkChip(l,g,v){const el=document.createElement('div');el.className='chip';el.dataset.g=g;el.dataset.v=v;el.textContent=l;el.onclick=()=>selChip(el,g);return el;}

function renderSettings(){
  document.getElementById('catList').innerHTML=categories.map((c,i)=>`<div class="cat-list-item"><span class="cat-list-emoji">${c.emoji}</span><span class="cat-list-name">${c.name}</span><button class="cat-del-btn" onclick="delCategory(${i})">Ã—</button></div>`).join('');
  document.getElementById('placeList').innerHTML=places.length?places.map((p,i)=>`<div class="place-item"><span class="place-name">${p}</span><button class="place-del-btn" onclick="delPlace(${i})">Ã—</button></div>`).join(''):'<div style="color:var(--muted);font-size:13px;padding:4px 0">ç™»éŒ²ãªã—</div>';
  document.getElementById('methodList').innerHTML=methods.length?methods.map((m,i)=>`<div class="method-item"><span class="method-name">${m}</span><button class="method-del-btn" onclick="delMethod(${i})">Ã—</button></div>`).join(''):'<div style="color:var(--muted);font-size:13px;padding:4px 0">ç™»éŒ²ãªã—</div>';
}

function addCategory(){const n=document.getElementById('newCatName').value.trim();if(!n){toast('ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','err');return;}categories.push({emoji:pickedEmoji,name:n});lss('kk_cats',categories);document.getElementById('newCatName').value='';document.getElementById('emojiPickBtn').textContent='â•';pickedEmoji='ğŸ“¦';renderSettings();renderForm();toast('ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ã—ã¾ã—ãŸ âœ“','ok');}
function delCategory(i){if(categories.length<=1){toast('æœ€ä½1ã¤ã¯å¿…è¦ã§ã™','err');return;}categories.splice(i,1);lss('kk_cats',categories);renderSettings();renderForm();}
function addPlace(){const n=document.getElementById('newPlaceName').value.trim();if(!n)return;places.push(n);lss('kk_places',places);document.getElementById('newPlaceName').value='';renderSettings();renderForm();toast('å ´æ‰€ã‚’è¿½åŠ ã—ã¾ã—ãŸ âœ“','ok');}
function delPlace(i){places.splice(i,1);lss('kk_places',places);renderSettings();renderForm();}
function addMethod(){const n=document.getElementById('newMethodName').value.trim();if(!n)return;methods.push(n);lss('kk_methods',methods);document.getElementById('newMethodName').value='';renderSettings();renderForm();toast('æ”¯æ‰•ã„æ–¹æ³•ã‚’è¿½åŠ ã—ã¾ã—ãŸ âœ“','ok');}
function delMethod(i){if(methods.length<=1){toast('æœ€ä½1ã¤ã¯å¿…è¦ã§ã™','err');return;}methods.splice(i,1);lss('kk_methods',methods);renderSettings();renderForm();}

function saveGasUrl(){const u=document.getElementById('gasUrlInput').value.trim();if(!u){toast('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','err');return;}gasUrl=u;lss('kk_gasurl',u);showGasStatus(true);toast('ä¿å­˜ã—ã¾ã—ãŸ âœ“','ok');loadRemote();}
function showGasStatus(ok){const el=document.getElementById('gasStatus');el.style.display='block';el.className='gas-status '+(ok?'ok':'ng');el.textContent=ok?'âœ“ é€£æºè¨­å®šæ¸ˆã¿':'âœ— æœªè¨­å®š';}

function buildEmojiGrid(){document.getElementById('emojiGrid').innerHTML=EMOJIS.map(e=>`<button class="e-btn" onclick="pickEmoji('${e}')">${e}</button>`).join('');}
function toggleEmojiPicker(e){e.stopPropagation();document.getElementById('emojiPicker').classList.toggle('open');}
function closeEmojiPicker(){document.getElementById('emojiPicker').classList.remove('open');}
function pickEmoji(e){pickedEmoji=e;document.getElementById('emojiPickBtn').textContent=e;closeEmojiPicker();}

function selChip(el,g){document.querySelectorAll(`[data-g="${g}"]`).forEach(c=>c.classList.remove('sel'));el.classList.add('sel');if(g==='cat')sCat=el.dataset.v;if(g==='payer')sPayer=el.dataset.v;if(g==='method')sMethod=el.dataset.v;if(g==='place')sPlace=el.dataset.v;if(g==='subject')sSubject=el.dataset.v;}
function selType(t){sType=t;document.getElementById('btnFixed').className='type-btn'+(t==='fixed'?' sel-fixed':'');document.getElementById('btnVar').className='type-btn'+(t==='variable'?' sel-var':'');}
function switchTab(n,btn){document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));document.getElementById('tab-'+n).classList.add('active');btn.classList.add('active');renderAll();}

async function doSubmit(){
  const date=document.getElementById('inputDate').value;
  const amount=parseFloat(cCur);
  const place=document.getElementById('inputPlace').value.trim()||sPlace;
  const memo=document.getElementById('inputMemo').value.trim();
  if(!date||!amount||amount<=0){toast('æ—¥ä»˜ã¨é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','err');return;}
  if(!sCat){toast('ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ãã ã•ã„','err');return;}
  if(!sType){toast('å›ºå®šè²»ã‹å¤‰å‹•è²»ã‚’é¸ã‚“ã§ãã ã•ã„','err');return;}
  if(!sMethod){toast('æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸ã‚“ã§ãã ã•ã„','err');return;}
  if(!sPayer){toast('æ”¯æ‰•ã„è€…ã‚’é¸ã‚“ã§ãã ã•ã„','err');return;}
  if(isExpense&&!sSubject){toast('å‹˜å®šç§‘ç›®ã‚’é¸ã‚“ã§ãã ã•ã„','err');return;}
  const rec={id:Date.now(),date,amount,category:sCat,type:sType,method:sMethod,payer:sPayer,place,memo,expense:isExpense,subject:isExpense?sSubject:''};
  records.unshift(rec);lss('kk_recs',records);
  const btn=document.getElementById('submitBtn');btn.disabled=true;btn.textContent='é€ä¿¡ä¸­â€¦';
  try{
    if(gasUrl)await fetch(gasUrl,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},body:JSON.stringify(rec)});
    toast('è¨˜éŒ²ã—ã¾ã—ãŸ âœ“','ok');resetForm();renderAll();
  }catch(e){toast('ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜æ¸ˆã¿ï¼ˆGASæœªé€ä¿¡ï¼‰','err');}
  finally{btn.disabled=false;btn.textContent='è¨˜éŒ²ã™ã‚‹';}
}

function resetForm(){
  calcClear();document.getElementById('inputMemo').value='';document.getElementById('inputPlace').value='';
  document.querySelectorAll('.chip').forEach(c=>c.classList.remove('sel'));
  document.getElementById('btnFixed').className='type-btn';document.getElementById('btnVar').className='type-btn';
  sCat='';sType='';sPayer='';sMethod='';sPlace='';sSubject='';isExpense=false;
  document.getElementById('expenseRow').classList.remove('checked');document.getElementById('expenseCheck').textContent='';document.getElementById('expenseSubjects').classList.remove('open');
  document.getElementById('inputDate').value=new Date().toISOString().split('T')[0];
}

async function loadRemote(){
  if(!gasUrl)return;
  const hc=document.getElementById('histCard');
  hc.innerHTML='<div class="loading-state"><div class="loading-spin">â³</div><div style="font-size:13px;color:var(--muted);margin-top:8px">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­â€¦</div></div>';
  try{
    const res=await fetch(gasUrl+'?action=getRecords');
    const data=await res.json();
    if(data.records&&Array.isArray(data.records)){
      const remoteIds=new Set(data.records.map(r=>String(r.id)));
      const localOnly=records.filter(r=>!remoteIds.has(String(r.id)));
      records=[...data.records,...localOnly].sort((a,b)=>new Date(b.date)-new Date(a.date)||b.id-a.id);
      lss('kk_recs',records);renderAll();toast('å±¥æ­´ã‚’æ›´æ–°ã—ã¾ã—ãŸ âœ“','ok');
    }
  }catch(e){renderAll();}
}

function setFilter(f,el){histFilter=f;document.querySelectorAll('.fchip').forEach(c=>c.classList.remove('sel'));el.classList.add('sel');renderAll();}

function thisMonth(){const now=new Date();const ym=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;return records.filter(r=>r.date&&r.date.startsWith(ym));}
const fmt=n=>(+n||0).toLocaleString();

function renderAll(){
  const list=thisMonth();
  const total=list.reduce((s,r)=>s+(+r.amount||0),0);
  document.getElementById('monthTotal').textContent=fmt(total);
  const fl=histFilter==='all'?list:histFilter==='expense'?list.filter(r=>r.expense):list.filter(r=>r.payer===histFilter);
  const hc=document.getElementById('histCard');
  if(!fl.length){hc.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ—’ï¸</div><div class="empty-text">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div></div>';}
  else{
    hc.innerHTML=fl.map(r=>{
      const ce=r.category?.split(' ')[0]||'ğŸ“¦';
      const sub=[r.date,r.payer,r.place].filter(Boolean).join(' Â· ');
      const isCard=r.method&&(r.method.includes('ã‚«ãƒ¼ãƒ‰')||r.method==='ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ');
      return`<div class="record-item">
        <div class="record-dot ${r.type||'variable'}">${ce}</div>
        <div class="record-body">
          <div class="record-cat">${r.category||'â€”'}${r.memo?' Â· '+r.memo:''}</div>
          <div class="record-sub">${sub}</div>
        </div>
        <div class="record-right">
          <div class="record-amount">Â¥${fmt(r.amount)}</div>
          <div class="rec-badges">
            <span class="rec-badge ${r.type==='fixed'?'rb-fixed':'rb-variable'}">${r.type==='fixed'?'å›ºå®š':'å¤‰å‹•'}</span>
            ${r.method?`<span class="rec-badge ${isCard?'rb-credit':'rb-cash'}">${r.method}</span>`:''}
            ${r.expense?`<span class="rec-badge rb-expense">ğŸ’¼ ${r.subject||'çµŒè²»'}</span>`:''}
          </div>
        </div>
      </div>`;
    }).join('');
  }
  const fixed=list.filter(r=>r.type==='fixed').reduce((s,r)=>s+(+r.amount||0),0);
  const vari=list.filter(r=>r.type==='variable').reduce((s,r)=>s+(+r.amount||0),0);
  const expense=list.filter(r=>r.expense).reduce((s,r)=>s+(+r.amount||0),0);
  document.getElementById('sTotal').textContent=`Â¥${fmt(total)}`;
  document.getElementById('sCount').textContent=`${list.length}ä»¶`;
  document.getElementById('sFixed').textContent=`Â¥${fmt(fixed)}`;
  document.getElementById('sVar').textContent=`Â¥${fmt(vari)}`;
  document.getElementById('sExpense').textContent=`Â¥${fmt(expense)}`;
  const rBars=(id,map)=>{const mx=Math.max(...Object.values(map),1);document.getElementById(id).innerHTML=Object.keys(map).length?Object.entries(map).sort((a,b)=>b[1]-a[1]).map(([k,v],i)=>`<div class="payer-row"><div class="payer-top"><span class="payer-name">${k}</span><span class="payer-amount">Â¥${fmt(v)}</span></div><div class="bar-track"><div class="bar-fill ${i===0?'orange':'navy'}" style="width:${(v/mx*100).toFixed(1)}%"></div></div></div>`).join(''):'<div style="color:var(--muted);font-size:13px;padding:6px 0">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';};
  const mm={},pm={},cm={};
  list.forEach(r=>{if(r.method)mm[r.method]=(mm[r.method]||0)+(+r.amount||0);if(r.payer)pm[r.payer]=(pm[r.payer]||0)+(+r.amount||0);if(r.category)cm[r.category]=(cm[r.category]||0)+(+r.amount||0);});
  rBars('methodBreak',mm);rBars('payerBreak',pm);
  const sorted=Object.entries(cm).sort((a,b)=>b[1]-a[1]);const cMax=sorted[0]?.[1]||1;
  document.getElementById('catBars').innerHTML=sorted.length?sorted.map(([c,a])=>`<div class="cat-row"><div class="cat-top"><span class="cat-top-name">${c}</span><span class="cat-top-amt">Â¥${fmt(a)}</span></div><div class="bar-track"><div class="bar-fill navy" style="width:${(a/cMax*100).toFixed(1)}%"></div></div></div>`).join(''):'<div style="color:var(--muted);font-size:13px;padding:6px 0">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
}

function toast(msg,type='ok'){const el=document.getElementById('toast');el.textContent=msg;el.className=`toast ${type} show`;clearTimeout(toast._t);toast._t=setTimeout(()=>el.className='toast',2800);}
</script>
</body>
</html>
