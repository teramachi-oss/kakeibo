<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>å®¶è¨ˆãƒ¡ãƒ¢</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400;500;700;900&family=Josefin+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --navy:   #1a2744;
  --navy2:  #243055;
  --navy3:  #2e3d6b;
  --orange: #f4651a;
  --white:  #ffffff;
  --off:    #f5f4f0;
  --border: #dde0ea;
  --muted:  #8890aa;
  --light:  #eef0f7;
  --red:    #e03e3e;
  --green:  #2a9d5c;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{background:var(--off);color:var(--navy);font-family:'Zen Kaku Gothic New',sans-serif;min-height:100dvh;padding-bottom:80px}

/* â”€â”€ HEADER â”€â”€ */
.header{background:var(--navy);padding:20px 20px 0;position:sticky;top:0;z-index:100}
.header-inner{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px}
.app-name{font-family:'Josefin Sans',sans-serif;font-size:11px;font-weight:600;letter-spacing:3px;text-transform:uppercase;color:rgba(255,255,255,.4);margin-bottom:4px}
.month-label{font-family:'Josefin Sans',sans-serif;font-size:22px;font-weight:700;color:#fff;letter-spacing:-.5px}
.total-label{font-size:10px;color:rgba(255,255,255,.4);letter-spacing:1.5px;text-transform:uppercase;font-family:'Josefin Sans',sans-serif;text-align:right;margin-bottom:2px}
.total-amount{font-family:'Josefin Sans',sans-serif;font-size:28px;font-weight:700;color:#fff;letter-spacing:-1px}
.total-yen{font-size:16px;font-weight:300;opacity:.7;margin-right:2px}
.tabs{display:flex;margin:0 -20px}
.tab-btn{flex:1;padding:11px 0 13px;background:none;border:none;color:rgba(255,255,255,.35);font-size:12px;font-family:'Josefin Sans',sans-serif;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;cursor:pointer;position:relative;transition:color .2s}
.tab-btn::after{content:'';position:absolute;bottom:0;left:50%;right:50%;height:3px;background:var(--orange);border-radius:3px 3px 0 0;transition:all .25s ease}
.tab-btn.active{color:#fff}
.tab-btn.active::after{left:12px;right:12px}

/* â”€â”€ CONTENT â”€â”€ */
.content{padding:20px}
.tab-panel{display:none}
.tab-panel.active{display:block;animation:fu .2s ease}
@keyframes fu{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€ CARD â”€â”€ */
.card{background:var(--white);border-radius:16px;padding:22px 20px;margin-bottom:14px;box-shadow:0 1px 3px rgba(26,39,68,.07),0 4px 14px rgba(26,39,68,.05)}

/* â”€â”€ FORM â”€â”€ */
.form-section{margin-bottom:20px}
.form-label{font-size:10px;font-weight:700;font-family:'Josefin Sans',sans-serif;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;display:block}
.amount-row{display:flex;align-items:center;background:var(--light);border:2px solid transparent;border-radius:12px;padding:0 16px;transition:border-color .2s,background .2s}
.amount-row:focus-within{border-color:var(--orange);background:#fff9f6}
.yen-sign{font-family:'Josefin Sans',sans-serif;font-size:20px;font-weight:300;color:var(--muted);padding-right:6px;user-select:none}
.amount-input{flex:1;background:none;border:none;outline:none;font-family:'Josefin Sans',sans-serif;font-size:32px;font-weight:700;color:var(--navy);padding:14px 0;letter-spacing:-1px;width:100%}
.amount-input::placeholder{color:var(--border)}
.form-input{width:100%;background:var(--light);border:2px solid transparent;border-radius:12px;padding:13px 16px;color:var(--navy);font-size:15px;font-family:'Zen Kaku Gothic New',sans-serif;outline:none;transition:border-color .2s,background .2s;-webkit-appearance:none}
.form-input:focus{border-color:var(--orange);background:#fff9f6}
.form-input::placeholder{color:var(--border)}

.chip-wrap{display:flex;flex-wrap:wrap;gap:7px}
.chip{padding:7px 13px;border-radius:8px;border:1.5px solid var(--border);background:var(--white);color:var(--muted);font-size:13px;font-family:'Zen Kaku Gothic New',sans-serif;font-weight:500;cursor:pointer;transition:all .15s;user-select:none}
.chip:active{transform:scale(.96)}
.chip.sel{background:var(--navy);border-color:var(--navy);color:#fff}

.type-toggle{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.type-btn{padding:12px;border-radius:12px;border:2px solid var(--border);background:var(--white);color:var(--muted);font-size:14px;font-family:'Zen Kaku Gothic New',sans-serif;font-weight:700;cursor:pointer;transition:all .15s;text-align:center}
.type-btn.sel-fixed{border-color:var(--navy);background:var(--navy);color:#fff}
.type-btn.sel-var{border-color:var(--orange);background:var(--orange);color:#fff}

/* æ”¯æ‰•ã„æ–¹æ³• toggle */
.pay-toggle{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.pay-btn{padding:11px;border-radius:12px;border:2px solid var(--border);background:var(--white);color:var(--muted);font-size:14px;font-family:'Zen Kaku Gothic New',sans-serif;font-weight:700;cursor:pointer;transition:all .15s;text-align:center}
.pay-btn.sel-credit{border-color:#2563eb;background:#2563eb;color:#fff}
.pay-btn.sel-cash{border-color:var(--green);background:var(--green);color:#fff}

.divider{height:1px;background:var(--border);margin:20px 0}
.submit-btn{width:100%;padding:16px;border-radius:12px;border:none;background:var(--orange);color:#fff;font-size:15px;font-family:'Josefin Sans',sans-serif;font-weight:700;letter-spacing:2.5px;text-transform:uppercase;cursor:pointer;transition:background .2s,transform .1s}
.submit-btn:active{transform:scale(.98);background:#d45510}
.submit-btn:disabled{opacity:.45;cursor:not-allowed}

/* â”€â”€ HISTORY â”€â”€ */
.section-label{font-family:'Josefin Sans',sans-serif;font-size:10px;font-weight:700;letter-spacing:2.5px;text-transform:uppercase;color:var(--muted);margin-bottom:12px}
.record-item{display:flex;align-items:center;gap:14px;padding:13px 0;border-bottom:1px solid var(--border)}
.record-item:last-child{border-bottom:none;padding-bottom:0}
.record-item:first-child{padding-top:0}
.record-dot{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.record-dot.fixed{background:var(--light)}
.record-dot.variable{background:#fff3ee}
.record-body{flex:1;min-width:0}
.record-cat{font-size:14px;font-weight:700;color:var(--navy);margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.record-sub{font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.record-right{text-align:right;flex-shrink:0}
.record-amount{font-family:'Josefin Sans',sans-serif;font-size:17px;font-weight:700;color:var(--navy);letter-spacing:-.5px}
.rec-badges{display:flex;gap:4px;justify-content:flex-end;margin-top:3px;flex-wrap:wrap}
.rec-badge{display:inline-block;font-size:10px;font-family:'Josefin Sans',sans-serif;font-weight:700;letter-spacing:1px;padding:2px 7px;border-radius:4px}
.rec-badge.fixed{background:var(--light);color:var(--navy3)}
.rec-badge.variable{background:#fff3ee;color:var(--orange)}
.rec-badge.credit{background:#eff6ff;color:#2563eb}
.rec-badge.cash{background:#f0fdf4;color:var(--green)}

.empty-state{text-align:center;padding:48px 0;color:var(--muted)}
.empty-icon{font-size:38px;margin-bottom:10px;opacity:.45}
.empty-text{font-size:13px;letter-spacing:.5px}

/* â”€â”€ SUMMARY â”€â”€ */
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
.stat-card{background:var(--white);border-radius:14px;padding:16px;box-shadow:0 1px 3px rgba(26,39,68,.06)}
.stat-card.accent-navy{background:var(--navy)}
.stat-label{font-family:'Josefin Sans',sans-serif;font-size:10px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:6px}
.stat-card.accent-navy .stat-label{color:rgba(255,255,255,.45)}
.stat-value{font-family:'Josefin Sans',sans-serif;font-size:22px;font-weight:700;color:var(--navy);letter-spacing:-.5px}
.stat-card.accent-navy .stat-value{color:#fff}
.stat-card.accent-orange .stat-value{color:var(--orange)}
.payer-row{padding:10px 0;border-bottom:1px solid var(--border)}
.payer-row:last-child{border-bottom:none}
.payer-top{display:flex;justify-content:space-between;margin-bottom:5px}
.payer-name{font-size:14px;font-weight:700;color:var(--navy)}
.payer-amount{font-family:'Josefin Sans',sans-serif;font-size:15px;font-weight:700;color:var(--navy)}
.bar-track{height:4px;background:var(--light);border-radius:2px;overflow:hidden}
.bar-fill{height:100%;border-radius:2px;transition:width .8s cubic-bezier(.16,1,.3,1)}
.bar-fill.orange{background:var(--orange)}
.bar-fill.navy{background:var(--navy)}
.cat-row{margin-bottom:13px}
.cat-row:last-child{margin-bottom:0}
.cat-top{display:flex;justify-content:space-between;font-size:13px;font-weight:500;margin-bottom:5px}
.cat-top-name{color:var(--navy)}
.cat-top-amt{font-family:'Josefin Sans',sans-serif;font-weight:700;color:var(--orange)}

/* â”€â”€ SETTINGS â”€â”€ */
.settings-section{margin-bottom:24px}
.settings-title{font-family:'Josefin Sans',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:12px}

/* ã‚«ãƒ†ã‚´ãƒªãƒªã‚¹ãƒˆ */
.cat-list{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
.cat-list-item{display:flex;align-items:center;gap:10px;background:var(--light);border-radius:10px;padding:10px 12px}
.cat-list-emoji{font-size:20px;width:28px;text-align:center;flex-shrink:0;cursor:pointer}
.cat-list-name{flex:1;font-size:14px;font-weight:500;color:var(--navy)}
.cat-del-btn{width:28px;height:28px;border-radius:7px;border:none;background:none;color:var(--muted);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .15s,color .15s;flex-shrink:0}
.cat-del-btn:hover{background:#fee2e2;color:var(--red)}

/* æ–°è¦è¿½åŠ è¡Œ */
.add-cat-row{display:flex;gap:8px;align-items:center}
.emoji-pick-btn{width:46px;height:46px;border-radius:10px;border:2px solid var(--border);background:var(--white);font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:border-color .15s}
.emoji-pick-btn:focus{border-color:var(--orange);outline:none}
.add-name-input{flex:1;background:var(--light);border:2px solid transparent;border-radius:10px;padding:11px 14px;font-size:15px;font-family:'Zen Kaku Gothic New',sans-serif;color:var(--navy);outline:none;transition:border-color .2s}
.add-name-input:focus{border-color:var(--orange);background:#fff9f6}
.add-name-input::placeholder{color:var(--border)}
.add-btn{padding:11px 16px;border-radius:10px;border:none;background:var(--navy);color:#fff;font-size:14px;font-family:'Josefin Sans',sans-serif;font-weight:700;letter-spacing:1px;cursor:pointer;flex-shrink:0;transition:background .15s}
.add-btn:active{background:var(--navy2)}

/* çµµæ–‡å­—ãƒ”ãƒƒã‚«ãƒ¼ */
.emoji-picker-wrap{position:relative}
.emoji-picker{position:absolute;top:calc(100% + 6px);left:0;z-index:300;background:var(--white);border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:0 8px 32px rgba(26,39,68,.15);display:none;width:260px}
.emoji-picker.open{display:block;animation:fu .15s ease}
.emoji-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
.e-btn{width:32px;height:32px;border:none;background:none;font-size:18px;cursor:pointer;border-radius:6px;transition:background .1s;display:flex;align-items:center;justify-content:center}
.e-btn:hover{background:var(--light)}

/* æ”¯æ‰•ã„æ–¹æ³•è¨­å®š */
.method-list{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
.method-item{display:flex;align-items:center;gap:10px;background:var(--light);border-radius:10px;padding:10px 14px}
.method-name{flex:1;font-size:14px;font-weight:500;color:var(--navy)}
.method-del-btn{width:28px;height:28px;border-radius:7px;border:none;background:none;color:var(--muted);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .15s,color .15s}
.method-del-btn:hover{background:#fee2e2;color:var(--red)}

/* è³¼å…¥å ´æ‰€è¨­å®š */
.place-list{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
.place-item{display:flex;align-items:center;gap:10px;background:var(--light);border-radius:10px;padding:10px 14px}
.place-name{flex:1;font-size:14px;font-weight:500;color:var(--navy)}
.place-del-btn{width:28px;height:28px;border-radius:7px;border:none;background:none;color:var(--muted);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .15s,color .15s}
.place-del-btn:hover{background:#fee2e2;color:var(--red)}

.add-simple-row{display:flex;gap:8px}
.add-simple-input{flex:1;background:var(--light);border:2px solid transparent;border-radius:10px;padding:11px 14px;font-size:15px;font-family:'Zen Kaku Gothic New',sans-serif;color:var(--navy);outline:none;transition:border-color .2s}
.add-simple-input:focus{border-color:var(--orange);background:#fff9f6}
.add-simple-input::placeholder{color:var(--border)}

/* â”€â”€ TOAST â”€â”€ */
.toast{position:fixed;bottom:96px;left:50%;transform:translateX(-50%) translateY(12px);background:var(--navy);color:#fff;padding:10px 24px;border-radius:30px;font-size:13px;font-family:'Josefin Sans',sans-serif;font-weight:600;letter-spacing:.5px;opacity:0;transition:all .3s ease;z-index:999;pointer-events:none;white-space:nowrap}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.ok{border-bottom:3px solid var(--orange)}
.toast.err{border-bottom:3px solid var(--red);background:#2d1e1e}

/* â”€â”€ BOTTOM NAV â”€â”€ */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--white);border-top:1px solid var(--border);display:flex;padding:6px 0 calc(6px + env(safe-area-inset-bottom));z-index:200}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;padding:7px 0;background:none;border:none;cursor:pointer;color:var(--border);font-size:9px;font-family:'Josefin Sans',sans-serif;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;transition:color .2s}
.nav-btn.active{color:var(--navy)}
.nav-icon{font-size:20px;line-height:1}
</style>
</head>
<body>

<div class="header">
  <div class="header-inner">
    <div>
      <div class="app-name">Kakeibo</div>
      <div class="month-label" id="monthLabel">â€”</div>
    </div>
    <div>
      <div class="total-label">ä»Šæœˆã®æ”¯å‡º</div>
      <div class="total-amount"><span class="total-yen">Â¥</span><span id="monthTotal">0</span></div>
    </div>
  </div>
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('input',this)">å…¥åŠ›</button>
    <button class="tab-btn" onclick="switchTab('history',this)">å±¥æ­´</button>
    <button class="tab-btn" onclick="switchTab('summary',this)">é›†è¨ˆ</button>
    <button class="tab-btn" onclick="switchTab('settings',this)">è¨­å®š</button>
  </div>
</div>

<div class="content">

  <!-- â”€â”€ å…¥åŠ› â”€â”€ -->
  <div class="tab-panel active" id="tab-input">
    <div class="card">
      <div class="form-section">
        <label class="form-label">é‡‘é¡</label>
        <div class="amount-row">
          <span class="yen-sign">Â¥</span>
          <input type="number" class="amount-input" id="inputAmount" placeholder="0" inputmode="numeric">
        </div>
      </div>

      <div class="form-section">
        <label class="form-label">æ—¥ä»˜</label>
        <input type="date" class="form-input" id="inputDate">
      </div>

      <div class="divider"></div>

      <div class="form-section">
        <label class="form-label">ã‚«ãƒ†ã‚´ãƒª</label>
        <div class="chip-wrap" id="catChips"></div>
      </div>

      <div class="form-section">
        <label class="form-label">å›ºå®šè²» / å¤‰å‹•è²»</label>
        <div class="type-toggle">
          <button class="type-btn" id="btnFixed" onclick="selType('fixed')">ğŸ”’ å›ºå®šè²»</button>
          <button class="type-btn" id="btnVar" onclick="selType('variable')">ğŸŒŠ å¤‰å‹•è²»</button>
        </div>
      </div>

      <div class="form-section">
        <label class="form-label">æ”¯æ‰•ã„æ–¹æ³•</label>
        <div class="chip-wrap" id="methodChips"></div>
      </div>

      <div class="form-section">
        <label class="form-label">æ”¯æ‰•ã„è€…</label>
        <div class="chip-wrap">
          <div class="chip" data-g="payer" data-v="å´‡ç§€" onclick="selChip(this,'payer')">å´‡ç§€</div>
          <div class="chip" data-g="payer" data-v="æœªç´—" onclick="selChip(this,'payer')">æœªç´—</div>
          <div class="chip" data-g="payer" data-v="å…±åŒ" onclick="selChip(this,'payer')">å…±åŒ</div>
        </div>
      </div>

      <div class="form-section">
        <label class="form-label">è³¼å…¥å ´æ‰€ï¼ˆä»»æ„ï¼‰</label>
        <div class="chip-wrap" id="placeChips" style="margin-bottom:8px"></div>
        <input type="text" class="form-input" id="inputPlace" placeholder="ã¾ãŸã¯ç›´æ¥å…¥åŠ›â€¦">
      </div>

      <div class="form-section" style="margin-bottom:0">
        <label class="form-label">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
        <input type="text" class="form-input" id="inputMemo" placeholder="è£œè¶³ãªã©">
      </div>

      <div class="divider"></div>
      <button class="submit-btn" id="submitBtn" onclick="doSubmit()">è¨˜éŒ²ã™ã‚‹</button>
    </div>
  </div>

  <!-- â”€â”€ å±¥æ­´ â”€â”€ -->
  <div class="tab-panel" id="tab-history">
    <div class="section-label">ä»Šæœˆã®è¨˜éŒ²</div>
    <div class="card" id="histCard">
      <div class="empty-state"><div class="empty-icon">ğŸ—’ï¸</div><div class="empty-text">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div></div>
    </div>
  </div>

  <!-- â”€â”€ é›†è¨ˆ â”€â”€ -->
  <div class="tab-panel" id="tab-summary">
    <div class="stat-grid">
      <div class="stat-card accent-navy">
        <div class="stat-label">ä»Šæœˆåˆè¨ˆ</div>
        <div class="stat-value" id="sTotal">Â¥0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ä»¶æ•°</div>
        <div class="stat-value" id="sCount">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">å›ºå®šè²»</div>
        <div class="stat-value" id="sFixed">Â¥0</div>
      </div>
      <div class="stat-card accent-orange">
        <div class="stat-label">å¤‰å‹•è²»</div>
        <div class="stat-value" id="sVar">Â¥0</div>
      </div>
    </div>

    <div class="section-label">æ”¯æ‰•ã„æ–¹æ³•åˆ¥</div>
    <div class="card" style="margin-bottom:14px"><div id="methodBreak"></div></div>

    <div class="section-label">æ”¯æ‰•ã„è€…åˆ¥</div>
    <div class="card" style="margin-bottom:14px"><div id="payerBreak"></div></div>

    <div class="section-label">ã‚«ãƒ†ã‚´ãƒªåˆ¥</div>
    <div class="card"><div id="catBars"></div></div>
  </div>

  <!-- â”€â”€ è¨­å®š â”€â”€ -->
  <div class="tab-panel" id="tab-settings">

    <!-- ã‚«ãƒ†ã‚´ãƒªç·¨é›† -->
    <div class="card settings-section">
      <div class="settings-title">ã‚«ãƒ†ã‚´ãƒª</div>
      <div class="cat-list" id="catList"></div>
      <div class="add-cat-row">
        <div class="emoji-picker-wrap">
          <button class="emoji-pick-btn" id="emojiPickBtn" onclick="toggleEmojiPicker(event)">â•</button>
          <div class="emoji-picker" id="emojiPicker">
            <div class="emoji-grid" id="emojiGrid"></div>
          </div>
        </div>
        <input type="text" class="add-name-input" id="newCatName" placeholder="ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›">
        <button class="add-btn" onclick="addCategory()">è¿½åŠ </button>
      </div>
    </div>

    <!-- è³¼å…¥å ´æ‰€ç·¨é›† -->
    <div class="card settings-section">
      <div class="settings-title">è³¼å…¥å ´æ‰€ï¼ˆã‚ˆãä½¿ã†å ´æ‰€ï¼‰</div>
      <div class="place-list" id="placeList"></div>
      <div class="add-simple-row">
        <input type="text" class="add-simple-input" id="newPlaceName" placeholder="ä¾‹ï¼šã‚¤ã‚ªãƒ³ã€è–¬å±€ãªã©">
        <button class="add-btn" onclick="addPlace()">è¿½åŠ </button>
      </div>
    </div>

    <!-- æ”¯æ‰•ã„æ–¹æ³•ç·¨é›† -->
    <div class="card settings-section" style="margin-bottom:0">
      <div class="settings-title">æ”¯æ‰•ã„æ–¹æ³•</div>
      <div class="method-list" id="methodList"></div>
      <div class="add-simple-row">
        <input type="text" class="add-simple-input" id="newMethodName" placeholder="ä¾‹ï¼šæ¥½å¤©ã‚«ãƒ¼ãƒ‰ã€PayPayãªã©">
        <button class="add-btn" onclick="addMethod()">è¿½åŠ </button>
      </div>
    </div>

  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbz5Kyuyu5Dtu0lqvo0IQDmmTJ2N0lyJhP91aP7uErO3Gl-iyG6tR5qyL76fixDKy9F-/exec';

// â”€â”€ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ â”€â”€
const DEFAULT_CATS = [
  {emoji:'ğŸ›’',name:'é£Ÿè²»'},{emoji:'ğŸ½',name:'å¤–é£Ÿ'},{emoji:'ğŸ ',name:'ä½å±…'},
  {emoji:'ğŸ’¡',name:'å…‰ç†±è²»'},{emoji:'ğŸ“±',name:'é€šä¿¡'},{emoji:'ğŸšƒ',name:'äº¤é€š'},
  {emoji:'ğŸ‘•',name:'è¡£é¡'},{emoji:'ğŸ’Š',name:'åŒ»ç™‚'},{emoji:'ğŸ‰',name:'å¨¯æ¥½'},
  {emoji:'ğŸ“š',name:'æ•™è‚²'},{emoji:'ğŸ¾',name:'ãƒšãƒƒãƒˆ'},{emoji:'ğŸ“¦',name:'ãã®ä»–'},
];
const DEFAULT_PLACES  = ['ã‚¹ãƒ¼ãƒ‘ãƒ¼','ã‚³ãƒ³ãƒ“ãƒ‹','ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢','ãƒãƒƒãƒˆé€šè²©'];
const DEFAULT_METHODS = ['ç¾é‡‘','ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ','PayPay','äº¤é€šç³»IC'];

const EMOJIS = ['ğŸ›’','ğŸ½','ğŸ ','ğŸ’¡','ğŸ“±','ğŸšƒ','ğŸ‘•','ğŸ’Š','ğŸ‰','ğŸ“š','ğŸ¾','ğŸ“¦',
  'ğŸµ','ğŸ‹','ğŸ¶','ğŸ±','ğŸŒ¸','â˜•','ğŸº','ğŸ®','âœˆ','ğŸ¥','ğŸ’¼','ğŸ',
  'ğŸ§´','ğŸ¥—','ğŸš—','âš½','ğŸ“·','ğŸ¯','ğŸ’°','ğŸ¦','ğŸ”‘','ğŸŒ¿','ğŸœ','ğŸ›'];

// â”€â”€ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ â”€â”€
function load(key, def) {
  try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : def; }
  catch { return def; }
}
function save(key, val) { localStorage.setItem(key, JSON.stringify(val)); }

let categories = load('kk_cats', DEFAULT_CATS);
let places     = load('kk_places', DEFAULT_PLACES);
let methods    = load('kk_methods', DEFAULT_METHODS);
let records    = load('kk_recs', []);

// â”€â”€ é¸æŠçŠ¶æ…‹ â”€â”€
let sCat='', sType='', sPayer='', sMethod='', sPlace='';
let pickedEmoji = 'ğŸ“¦';

// â”€â”€ Init â”€â”€
window.onload = () => {
  const now = new Date();
  document.getElementById('inputDate').value = now.toISOString().split('T')[0];
  document.getElementById('monthLabel').textContent =
    `${now.getFullYear()}å¹´ ${now.getMonth()+1}æœˆ`;
  buildEmojiGrid();
  renderForm();
  renderSettings();
  renderAll();
  // ãƒ”ãƒƒã‚«ãƒ¼å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  document.addEventListener('click', e => {
    if (!e.target.closest('.emoji-picker-wrap')) closeEmojiPicker();
  });
};

// â”€â”€ ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒƒãƒ—å†æ§‹ç¯‰ â”€â”€
function renderForm() {
  // ã‚«ãƒ†ã‚´ãƒª
  const cw = document.getElementById('catChips');
  cw.innerHTML = '';
  sCat = '';
  categories.forEach(c => {
    const label = c.emoji + ' ' + c.name;
    const el = document.createElement('div');
    el.className = 'chip'; el.dataset.g = 'cat'; el.dataset.v = label;
    el.textContent = label;
    el.onclick = () => selChip(el, 'cat');
    cw.appendChild(el);
  });

  // æ”¯æ‰•ã„æ–¹æ³•
  const mw = document.getElementById('methodChips');
  mw.innerHTML = '';
  sMethod = '';
  methods.forEach(m => {
    const el = document.createElement('div');
    el.className = 'chip'; el.dataset.g = 'method'; el.dataset.v = m;
    el.textContent = m;
    el.onclick = () => selChip(el, 'method');
    mw.appendChild(el);
  });

  // è³¼å…¥å ´æ‰€
  const pw = document.getElementById('placeChips');
  pw.innerHTML = '';
  sPlace = '';
  places.forEach(p => {
    const el = document.createElement('div');
    el.className = 'chip'; el.dataset.g = 'place'; el.dataset.v = p;
    el.textContent = p;
    el.onclick = () => {
      selChip(el, 'place');
      document.getElementById('inputPlace').value = p;
    };
    pw.appendChild(el);
  });
}

// â”€â”€ è¨­å®šç”»é¢å†æ§‹ç¯‰ â”€â”€
function renderSettings() {
  // ã‚«ãƒ†ã‚´ãƒªãƒªã‚¹ãƒˆ
  const cl = document.getElementById('catList');
  cl.innerHTML = categories.map((c,i) => `
    <div class="cat-list-item">
      <span class="cat-list-emoji">${c.emoji}</span>
      <span class="cat-list-name">${c.name}</span>
      <button class="cat-del-btn" onclick="delCategory(${i})">Ã—</button>
    </div>`).join('');

  // å ´æ‰€ãƒªã‚¹ãƒˆ
  const pl = document.getElementById('placeList');
  pl.innerHTML = places.length
    ? places.map((p,i) => `
        <div class="place-item">
          <span class="place-name">${p}</span>
          <button class="place-del-btn" onclick="delPlace(${i})">Ã—</button>
        </div>`).join('')
    : '<div style="color:var(--muted);font-size:13px;padding:4px 0">ç™»éŒ²ãªã—</div>';

  // æ”¯æ‰•ã„æ–¹æ³•ãƒªã‚¹ãƒˆ
  const ml = document.getElementById('methodList');
  ml.innerHTML = methods.length
    ? methods.map((m,i) => `
        <div class="method-item">
          <span class="method-name">${m}</span>
          <button class="method-del-btn" onclick="delMethod(${i})">Ã—</button>
        </div>`).join('')
    : '<div style="color:var(--muted);font-size:13px;padding:4px 0">ç™»éŒ²ãªã—</div>';
}

// â”€â”€ ã‚«ãƒ†ã‚´ãƒªè¿½åŠ ãƒ»å‰Šé™¤ â”€â”€
function addCategory() {
  const name = document.getElementById('newCatName').value.trim();
  if (!name) { toast('ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'err'); return; }
  categories.push({ emoji: pickedEmoji, name });
  save('kk_cats', categories);
  document.getElementById('newCatName').value = '';
  document.getElementById('emojiPickBtn').textContent = 'â•';
  pickedEmoji = 'ğŸ“¦';
  renderSettings();
  renderForm();
  toast('ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ã—ã¾ã—ãŸ âœ“', 'ok');
}
function delCategory(i) {
  if (categories.length <= 1) { toast('æœ€ä½1ã¤ã¯å¿…è¦ã§ã™', 'err'); return; }
  categories.splice(i, 1);
  save('kk_cats', categories);
  renderSettings();
  renderForm();
}

// â”€â”€ å ´æ‰€è¿½åŠ ãƒ»å‰Šé™¤ â”€â”€
function addPlace() {
  const name = document.getElementById('newPlaceName').value.trim();
  if (!name) return;
  places.push(name);
  save('kk_places', places);
  document.getElementById('newPlaceName').value = '';
  renderSettings();
  renderForm();
  toast('å ´æ‰€ã‚’è¿½åŠ ã—ã¾ã—ãŸ âœ“', 'ok');
}
function delPlace(i) {
  places.splice(i, 1);
  save('kk_places', places);
  renderSettings();
  renderForm();
}

// â”€â”€ æ”¯æ‰•ã„æ–¹æ³•è¿½åŠ ãƒ»å‰Šé™¤ â”€â”€
function addMethod() {
  const name = document.getElementById('newMethodName').value.trim();
  if (!name) return;
  methods.push(name);
  save('kk_methods', methods);
  document.getElementById('newMethodName').value = '';
  renderSettings();
  renderForm();
  toast('æ”¯æ‰•ã„æ–¹æ³•ã‚’è¿½åŠ ã—ã¾ã—ãŸ âœ“', 'ok');
}
function delMethod(i) {
  if (methods.length <= 1) { toast('æœ€ä½1ã¤ã¯å¿…è¦ã§ã™', 'err'); return; }
  methods.splice(i, 1);
  save('kk_methods', methods);
  renderSettings();
  renderForm();
}

// â”€â”€ çµµæ–‡å­—ãƒ”ãƒƒã‚«ãƒ¼ â”€â”€
function buildEmojiGrid() {
  const grid = document.getElementById('emojiGrid');
  grid.innerHTML = EMOJIS.map(e => `
    <button class="e-btn" onclick="pickEmoji('${e}')">${e}</button>`).join('');
}
function toggleEmojiPicker(e) {
  e.stopPropagation();
  document.getElementById('emojiPicker').classList.toggle('open');
}
function closeEmojiPicker() {
  document.getElementById('emojiPicker').classList.remove('open');
}
function pickEmoji(emoji) {
  pickedEmoji = emoji;
  document.getElementById('emojiPickBtn').textContent = emoji;
  closeEmojiPicker();
}

// â”€â”€ æ±ç”¨ãƒãƒƒãƒ—é¸æŠ â”€â”€
function selChip(el, g) {
  document.querySelectorAll(`[data-g="${g}"]`).forEach(c => c.classList.remove('sel'));
  el.classList.add('sel');
  if (g === 'cat')    sCat    = el.dataset.v;
  if (g === 'payer')  sPayer  = el.dataset.v;
  if (g === 'method') sMethod = el.dataset.v;
  if (g === 'place')  sPlace  = el.dataset.v;
}
function selType(t) {
  sType = t;
  document.getElementById('btnFixed').className = 'type-btn' + (t==='fixed'  ? ' sel-fixed' : '');
  document.getElementById('btnVar').className   = 'type-btn' + (t==='variable'? ' sel-var'   : '');
}

// â”€â”€ ã‚¿ãƒ–åˆ‡æ›¿ â”€â”€
function switchTab(name, btn) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  btn.classList.add('active');
  renderAll();
}

// â”€â”€ é€ä¿¡ â”€â”€
async function doSubmit() {
  const date   = document.getElementById('inputDate').value;
  const amount = parseInt(document.getElementById('inputAmount').value);
  const place  = document.getElementById('inputPlace').value.trim() || sPlace;
  const memo   = document.getElementById('inputMemo').value.trim();

  if (!date || !amount || amount<=0) { toast('æ—¥ä»˜ã¨é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','err'); return; }
  if (!sCat)    { toast('ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ãã ã•ã„','err'); return; }
  if (!sType)   { toast('å›ºå®šè²»ã‹å¤‰å‹•è²»ã‚’é¸ã‚“ã§ãã ã•ã„','err'); return; }
  if (!sMethod) { toast('æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸ã‚“ã§ãã ã•ã„','err'); return; }
  if (!sPayer)  { toast('æ”¯æ‰•ã„è€…ã‚’é¸ã‚“ã§ãã ã•ã„','err'); return; }

  const rec = { id:Date.now(), date, amount, category:sCat, type:sType,
                method:sMethod, payer:sPayer, place, memo };
  records.unshift(rec);
  save('kk_recs', records);

  const btn = document.getElementById('submitBtn');
  btn.disabled=true; btn.textContent='é€ä¿¡ä¸­â€¦';
  try {
    if (GAS_URL !== 'YOUR_GAS_WEB_APP_URL') {
      await fetch(GAS_URL, {
        method:'POST', mode:'no-cors',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(rec)
      });
    }
    toast('è¨˜éŒ²ã—ã¾ã—ãŸ âœ“','ok');
    resetForm();
    renderAll();
  } catch(e) {
    toast('ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜æ¸ˆã¿ï¼ˆGASæœªé€ä¿¡ï¼‰','err');
  } finally {
    btn.disabled=false; btn.textContent='è¨˜éŒ²ã™ã‚‹';
  }
}

function resetForm() {
  document.getElementById('inputAmount').value='';
  document.getElementById('inputMemo').value='';
  document.getElementById('inputPlace').value='';
  document.querySelectorAll('.chip').forEach(c=>c.classList.remove('sel'));
  document.getElementById('btnFixed').className='type-btn';
  document.getElementById('btnVar').className='type-btn';
  sCat=''; sType=''; sPayer=''; sMethod=''; sPlace='';
  document.getElementById('inputDate').value=new Date().toISOString().split('T')[0];
}

// â”€â”€ æç”» â”€â”€
function thisMonth() {
  const now=new Date();
  const ym=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  return records.filter(r=>r.date.startsWith(ym));
}
const fmt = n => n.toLocaleString();

function renderAll() {
  const list  = thisMonth();
  const total = list.reduce((s,r)=>s+r.amount,0);
  document.getElementById('monthTotal').textContent = fmt(total);

  // å±¥æ­´
  const hc = document.getElementById('histCard');
  if (!list.length) {
    hc.innerHTML=`<div class="empty-state"><div class="empty-icon">ğŸ—’ï¸</div><div class="empty-text">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div></div>`;
  } else {
    hc.innerHTML = list.map(r => {
      const catEmoji = r.category?.split(' ')[0] || 'ğŸ“¦';
      const subParts = [r.date, r.payer, r.place].filter(Boolean);
      const mBadgeClass = (r.method==='ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ'||r.method?.includes('ã‚«ãƒ¼ãƒ‰')) ? 'credit' : 'cash';
      return `
      <div class="record-item">
        <div class="record-dot ${r.type}">${catEmoji}</div>
        <div class="record-body">
          <div class="record-cat">${r.category}${r.memo?' Â· '+r.memo:''}</div>
          <div class="record-sub">${subParts.join(' Â· ')}</div>
        </div>
        <div class="record-right">
          <div class="record-amount">Â¥${fmt(r.amount)}</div>
          <div class="rec-badges">
            <span class="rec-badge ${r.type==='fixed'?'fixed':'variable'}">${r.type==='fixed'?'å›ºå®š':'å¤‰å‹•'}</span>
            ${r.method?`<span class="rec-badge ${mBadgeClass}">${r.method}</span>`:''}
          </div>
        </div>
      </div>`;
    }).join('');
  }

  // é›†è¨ˆ
  const fixed = list.filter(r=>r.type==='fixed').reduce((s,r)=>s+r.amount,0);
  const vari  = list.filter(r=>r.type==='variable').reduce((s,r)=>s+r.amount,0);
  document.getElementById('sTotal').textContent=`Â¥${fmt(total)}`;
  document.getElementById('sCount').textContent=`${list.length}ä»¶`;
  document.getElementById('sFixed').textContent=`Â¥${fmt(fixed)}`;
  document.getElementById('sVar').textContent=`Â¥${fmt(vari)}`;

  // æ”¯æ‰•ã„æ–¹æ³•åˆ¥
  const mm={};
  list.forEach(r=>{ if(r.method) mm[r.method]=(mm[r.method]||0)+r.amount; });
  const mMax=Math.max(...Object.values(mm),1);
  document.getElementById('methodBreak').innerHTML = Object.keys(mm).length
    ? Object.entries(mm).sort((a,b)=>b[1]-a[1]).map(([m,a],i)=>`
        <div class="payer-row">
          <div class="payer-top">
            <span class="payer-name">${m}</span>
            <span class="payer-amount">Â¥${fmt(a)}</span>
          </div>
          <div class="bar-track"><div class="bar-fill ${i===0?'orange':'navy'}" style="width:${(a/mMax*100).toFixed(1)}%"></div></div>
        </div>`).join('')
    : '<div style="color:var(--muted);font-size:13px;padding:6px 0">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';

  // æ”¯æ‰•ã„è€…åˆ¥
  const pm={};
  list.forEach(r=>{ pm[r.payer]=(pm[r.payer]||0)+r.amount; });
  const pMax=Math.max(...Object.values(pm),1);
  document.getElementById('payerBreak').innerHTML = Object.keys(pm).length
    ? Object.entries(pm).sort((a,b)=>b[1]-a[1]).map(([p,a],i)=>`
        <div class="payer-row">
          <div class="payer-top">
            <span class="payer-name">${p}</span>
            <span class="payer-amount">Â¥${fmt(a)}</span>
          </div>
          <div class="bar-track"><div class="bar-fill ${i===0?'orange':'navy'}" style="width:${(a/pMax*100).toFixed(1)}%"></div></div>
        </div>`).join('')
    : '<div style="color:var(--muted);font-size:13px;padding:6px 0">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';

  // ã‚«ãƒ†ã‚´ãƒªåˆ¥
  const cm={};
  list.forEach(r=>{ cm[r.category]=(cm[r.category]||0)+r.amount; });
  const sorted=Object.entries(cm).sort((a,b)=>b[1]-a[1]);
  const cMax=sorted[0]?.[1]||1;
  document.getElementById('catBars').innerHTML = sorted.length
    ? sorted.map(([c,a])=>`
        <div class="cat-row">
          <div class="cat-top">
            <span class="cat-top-name">${c}</span>
            <span class="cat-top-amt">Â¥${fmt(a)}</span>
          </div>
          <div class="bar-track"><div class="bar-fill navy" style="width:${(a/cMax*100).toFixed(1)}%"></div></div>
        </div>`).join('')
    : '<div style="color:var(--muted);font-size:13px;padding:6px 0">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
}

// â”€â”€ Toast â”€â”€
function toast(msg, type='ok') {
  const el=document.getElementById('toast');
  el.textContent=msg; el.className=`toast ${type} show`;
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>el.className='toast',2800);
}
</script>
</body>
</html>
